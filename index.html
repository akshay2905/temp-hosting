<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Budget Visualisation</title>

    <!-- Bootstrap Core CSS -->
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet">

    <link href="favicon.ico" rel="icon" type="image/x-icon" />

    <link href="css/sb-admin-2.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link href="css/custom.css" rel="stylesheet">
    <!--Font Awesom CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">

    <link href='https://fonts.googleapis.com/css?family=PT+Sans' rel='stylesheet' type='text/css'>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <style>


.axis path,
.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

.x.axis path {
  display: none;
}

.line {
  fill: none;
  stroke: steelblue;
  stroke-width: 1.5px;
}
.year-selection{
  width:100px;
}

#left-div {
    float: left;
    width: 100px;
    height: 20px;
    margin-right: 8px;
    
}
#right-div {
    margin-left: 450px;
    
}
    </style>
</head>

<body>

    <div id="wrapper">

        <!-- Sidebar -->
        <div id="sidebar-wrapper">
            <div class="visualisation-title">
                    <h4>Visualisation Title</h4><br>
            </div>
            <div class="col-lg-12">
                
                <div class="panel panel-default">
                    <div class="panel-heading description-heading">
                        <h2 class="panel-title"><i class="fa fa-list-alt"></i> Description</h2>
                    </div>
                    <div class="panel-body">
                        
                        Quisque sollicitudin sem augue, et tempor mi fringilla quis. Ut non gravida ligula. Maecenas elementum tortor ac sollicitudin porttitor. Vestibulum condimentum urna et ipsum vehicula, quis tempus sem vestibulum. Quisque in euismod nisl. Cras in diam in tortor consequat gravida vulputate congue dolor. Donec fermentum sapien sed sollicitudin dignissim.
                        

                    </div>
                </div>

                <button id="download" type="button " class="down btn btn-primary btn-lg btn-block"><i class="fa fa-download"></i> Download</button>
                


            </div>
            <div class="sidebar-bottom-content">
                      <a href="#" class="bottom-links"> <i class="fa fa-file"></i> Glossary</a>
                      <a href="#" class="bottom-links"><i class="fa fa-phone"></i> Contact Us</a>
                    
                </div>
        </div>
        <!-- /#sidebar-wrapper -->

        <!-- Page Content -->
        <div id="page-content-wrapper">
          <a href="#menu-toggle" class="btn btn-default" id="menu-toggle" ><i id="arrow" class="fa fa-arrow-left"></i></a>
            <div class="container-fluid">
                <div class="row">
                    <div class="col-lg-12" style="padding:0px;
    padding-right: 10px;">
                        

                        <div class="row budget-select">  
                            <p id="menu" class="menuchoice">
                              <select class="form-control" id="sel1">
                              <option value="Actual Budget">Actual Budget</option>
                               <option value="Revised Budget">Revised Budget</option>
                              <option value="Budget">Budget</option>
                               
                              </select>
                            </p>
                            </div>
                            
                        </div>
                        <div class="row">
                            <div class="col-lg-12">
                                <div class="panel panel-default">
                                    <div class="panel-heading chart-heading">
                                        <h2 class="panel-title"><i class="fa fa-line-chart"></i> Chart</h2>
                                    </div>
                                    <div class="panel-body">
                                        <div class="col-sm-9 chart-column">
                                            <div class"row selection-row">
                                              <div class="col-md-12 selection-column">
                                              </div>
                                            </div>
                                            <div class="chart-area"></div>
                                        </div>
                                        <div class="col-sm-3 ">
                                            <div class="panel panel-default">
                                            <div class="panel-heading figures-heading">
                                                <h2 class="panel-title"><i class="fa fa-briefcase"></i> Budget Figures</h2>
                                            </div>
                                            <div class="panel-body chart-figures">
                                                <table class="table figures-table">
                                                  <thead>
                                                    <tr>
                                                      <th id="figure-heading">Scheme Name
                                                      </th>
                                                    </tr>
                                                  </thead>
                                                  <tbody>
                                                    <tr>
                                                      <td id="figure-year1">
                                                        Year : Figures</td>
                                                    </tr>
                                                    <tr>
                                                      <td id="figure-year2">
                                                        Year  : Figures</td>
                                                    </tr>
                                                  </tbody>
                                                </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="trendline" ></div>

                        <div class="row">
                            <div class="col-lg-4">
                                <div class="container-fluid department-table">
                                  <div class="panel panel-default">
                                    <div class="panel-heading ">
                                        <h2 class="panel-title"><i class="fa fa-book"></i> Budget Estimates</h2>
                                    </div>
                                    <div class="panel-body table-div">

                                            
                                          </div>
                                        </div>
                                        
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- /#page-content-wrapper -->

    </div>
    <!-- /#wrapper -->

    <!-- jQuery -->
    <script src="js/jquery.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="js/bootstrap.min.js"></script>

    <!-- Menu Toggle Script -->

    <script>
    $("#menu-toggle").click(function(e) {
        e.preventDefault();
        $("#wrapper").toggleClass("toggled");
        $("#arrow").toggleClass("fa-arrow-right fa-arrow-left")


    });
    </script>   

    <script src="http://d3js.org/d3.v3.min.js"></script>

<script>


 var margin = { top: 10, right: 100, bottom: 40, left: 40 };
  var height = 400 - margin.top - margin.bottom;
  var width = 660 - margin.left - margin.right;




var x = d3.scale.ordinal()
    .domain([0,1])
    // Setting the rangePoints instead of rangeBands
    .rangePoints([0, width], 0);
var y = d3.scale.linear()
    .range([height, 0]);

var y1 = d3.scale.linear()
    .range([height, 0]);

var color = d3.scale.category10();

var xAxis = d3.svg.axis()
    .scale(x)
    .tickFormat("")
    .orient("bottom");

var yAxis = d3.svg.axis()
    .scale(y)

    .orient("left");

var y2Axis = d3.svg.axis()
    .scale(y1)
    .tickFormat("")
    .orient("left");

var line = d3.svg.line()
    .interpolate("linear")
    .x(function(d) { return x(d.ide); })
    .y(function(d) { return y(d.budget); });




//Redraw Begin
var menu = d3.select("#menu select")
    .on("change", change);  


d3.csv("budget_revision.csv", function(error, data) {
                      var parseDate = d3.time.format("%Y").parse;
                      if (error) throw error;
                      
                       data.forEach(function(d) {
                        d.date = parseDate(d.date);
                        
                      }); 
                      formatted = data;
            
                      redraw();

                      
  
});
 
d3.select(window)
    .on("keydown", function() { altKey = d3.event.altKey; })
    .on("keyup", function() { altKey = false; });
var altKey;


function change() {
  d3.transition()
      .duration(altKey ? 7500 : 1500)
      .each(redraw);
}





function redraw() { 

  d3.select("svg").remove();
  d3.select("div.selection-column").select("div").remove();
  d3.select("div.selection-column").select("div").remove();
  d3.select("div.table-div").select("table").remove();


 

  var svg = d3.select("body").select("div.chart-area").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
  .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");


  var nested = d3.nest()
    .key(function(d) { return d.Type; })
    .map(formatted)
  
  
    // get value from menu selection
    // the option values are set in HTML and correspond
    //to the [type] value we used to nest the data  
    var series = menu.property("value");
    
    // only retrieve data from the selected series, using the nest we just created
    var data = nested[series];

  

  var years=[];
for(var j=0;j<data.length;j++){
  var obj=data[j];
  years.push(obj.date.getFullYear());
}

var year1=years[0];
var year2=years[years.length-1];
  var select = d3.select("body").select("div.selection-column")
    .append("div")
    .attr("class","year-selection ")
    .attr("id","left-div")
    .append("select")
    .attr("class","form-control")
    .attr("id","left-select")
      .on("change", function() { var other_div=d3.select("#right-select").property("value");
        updateData(this.value,other_div,formatted) });
  

  select
  .selectAll("option")
      .data(data)
    .enter().append("option")
    .attr("class","left-selection")
      .attr("value", function(d) { return d.date.getFullYear(); })
      .text(function(d) { return d.date.getFullYear(); })
      .style("margin","0px 0px 0px 0px");
      

  var select2 = d3.select("body").select("div.selection-column")
    .append("div")
    .attr("class","year-selection")
    .attr("id","right-div")
    .append("select")
    .attr("class","form-control")
    .attr("id","right-select")
      .on("change", function() {var other_div=d3.select("#left-select").property("value"); 
        updateData(this.value,other_div,nested[series]) });


  select2.selectAll("option")
      .data(data)
    .enter().append("option")
      .attr("class","right-selection")
      .attr("value", function(d) { return d.date.getFullYear(); })
      
      .text(function(d) { return d.date.getFullYear(); })

var checkOption = function (e) {

        if(e == data[data.length-1]){
       
            return d3.select(this).attr("selected", "selected");
        }
    };
    
    select2.selectAll("option").each(checkOption);
      

   
    
    dataset=[];
    for(var i = 0; i < data.length; i++) {
    var obj = data[i];
    if(obj.date.getFullYear()==year1){
      obj.ide=parseInt("0");
      dataset.push(obj);
    }
      
}
  for(var j = 0 ; j<data.length;j++){
    var obj1=data[j];
    if( obj1.date.getFullYear()==year2){
      obj1.ide=parseInt("1");
      dataset.push(obj1);
    }
  }

  if(dataset[0].date==dataset[1].date){
var temp = jQuery.extend(true, {}, dataset[0]);
temp.ide=0;
dataset[0]=temp;
}

  color.domain(d3.keys(dataset[0]).filter(function(key) { return key !== "date" && key!== "Type"; }));



  var schemes = color.domain().map(function(name) {
    
    return {
      name: name,
      values: dataset.map(function(d) { 
        return { budget: +d[name],ide:d.ide};
     
      })
    };
  });
 


  schemes.pop();
 x.domain(d3.extent(dataset, function(d) { return d.ide; }));
  y.domain([
    d3.min(schemes, function(c) { return d3.min(c.values, function(v) { return v.budget; }); }),
    d3.max(schemes, function(c) { return d3.max(c.values, function(v) { return v.budget; }); })
  ]);
y1.domain([
    d3.min(schemes, function(c) { return d3.min(c.values, function(v) { return v.budget; }); }),
    d3.max(schemes, function(c) { return d3.max(c.values, function(v) { return v.budget; }); })
  ]);
  
  
svg.append("g")
      .attr("class", "x axis")
      .attr("transform", "translate(0," + height + ")")
      .call(xAxis);


  svg.append("g")
      .attr("class", "y axis")
      .call(yAxis)
      .append("text")
          .attr("transform","rotate(-90)")
          .attr("y",-50)
          .attr("dy",".51em")
          .style("text-anchor","end")
          .text("Price ($)");
    
      

      svg.append("g")       
        .attr("class", "y axis")  
        .attr("transform", "translate(" + width + " ,0)") 
        .call(y2Axis)

      

  var scheme = svg.selectAll(".scheme")
      .data(schemes)
    .enter().append("g")
      .attr("class", "scheme");

  scheme.append("path")
      .attr("class", "line")
      .attr("id",function(d,i){ return "id" + i; })
      .attr("d", function(d) { return line(d.values); })
      .style("stroke", function(d) { return color(d.name); });



  scheme
  .append("text")
    .datum(function(d) { return {name: d.name, value: d.values[d.values.length - 1]}; })    
      .attr("transform", function(d) { return "translate(" + (x(d.value.ide) +10)+ "," + y(d.value.budget) + ")"; })
      .attr("id",function(d,i){ return "text_id" + i; })
      .attr("x", 3)
      .attr("dy", ".35em")
      
      .text(function(d) { return d.name; })
      .on("click", function(d) { var url="trend_analysis.html?scheme="+d.name;
        window.open(url); })
      .on("mouseover",function(d,i) { 
        var scheme_name=d3.select("#text_id"+i).html();
        var year1_val, year2_val,year1_num,year2_num; 
        for (var k=0;k<schemes.length;k++){

          if(schemes[k].name==scheme_name){
            year1_val=schemes[k].values[0].budget;
            year2_val=schemes[k].values[1].budget;
            //year1_num=schemes[i].values[0].date.getFullYear();
            //year2_num=schemes[i].values[1].date.getFullYear();
          }
        }
  
        d3.select("#figure-heading").html(scheme_name).on("click", function(d) { var url="trend_analysis.html?scheme="+scheme_name;
        window.open(url); });
        d3.select("#figure-year1").html(year1 + " : " +year1_val+" (Cr)");
        d3.select("#figure-year2").html(year2 + " : " +year2_val+" (Cr)");
          for (j=0; j < 6; j++) {
            if (i !== j) {
              d3.select("#id"+j).style("opacity",0.1);
              d3.select("#text_id"+j).style("opacity",0.2);
              d3.select("#text_id"+i).style("font-size","13px");
              d3.select("#row_id"+j).style("opacity",0.2);
              d3.select("#row_id"+i).style("background-color","#FFF056").style("font-weight","bold");
            }
          };
        })
        .on("mouseout", function(d,i) {
          for (j=0; j < 6; j++) {
            d3.select("#id"+j).style("opacity",1);
            d3.select("#text_id"+j).style("opacity",1);
            d3.select("#text_id"+i).style("font-size","10px");
            d3.select("#row_id"+j).style("opacity",1).style("background-color","white").style("font-weight","normal");
          };
        });
//Trendline
var scheme2 = color.domain().map(function(name) {
    
    return {
      name: name,
      values: data.map(function(d) { 
        return { budget: +d[name],date:d.date};
     
      })
    };
  });
var tr_width = 100;
var tr_height = 25;
var tr_x = d3.time.scale().range([0, tr_width - 2]);
var tr_y = d3.scale.linear().range([tr_height - 4, 0]);
var tr_line = d3.svg.line()
             .interpolate("basis")
            .x(function(d) { return x(d.date); })
            .y(function(d) { return y(d.budget); });
          
              



  //Populate Table with data

   // The table generation function
columns=["name"];
    


var scheme2 = color.domain().map(function(name) {
    
    return {
      name: name,
      values: data.map(function(d) { 
        return { budget: +d[name],date:d.date};
     
      })
    };
  });
 scheme2.pop()   





var table = d3.select("body").select("div.table-div")
    .attr("style", "padding: 20px")
    .append("table")
    .attr("class","table")
        thead = table.append("thead"),
        tbody = table.append("tbody");

var thead = table.append("thead").append("tr");

thead.selectAll("th")
    .data(columns)
    .enter()
    .append("th")
    .text(function(d) {
        return d.toUpperCase();
    });

var tbody = table.append("tbody");

var trows = tbody
    .selectAll("tr")
    .data(scheme2)
    .enter()
    .append("tr")
    .attr("id",function(d,i){ return "row_id" + i; });

     // create a cell in each row for each column
   var cells = trows.selectAll("td")
        .data(function(row) {
            return columns.map(function(column) {
              
                return {column: column, value: row[column]};
            });
        })
        .enter()
        .append("td")
        .attr("style", "font-family: Courier") // sets the font style
            .html(function(d) {return (d.value); });
    
thead.append("th").text('Graphs');

trows.selectAll("td.graph")  
//use a class so you don't re-select the existing <td> elements
          .data(function(row) {
            return [row];
        })
          .enter()
            .append("td")
            .attr("class", "graph")
            .each(lines)
            .style("height","40px")
            .style("width","100px"); 



    function lines(scheme_data) {  
    var width = 100, height = 20; 
   
    var sc_data = []
    for (i = 0; i < scheme_data.values.length; i++) {
        
        sc_data[i] = {
            'x': scheme_data.values[i].date,
            'y': scheme_data.values[i].budget
        }
    }
    
    var x = d3.time.scale()
        .range([0, width ])
        .domain(d3.extent(sc_data, function(d) {return d.x; }));

    var y = d3.scale.linear()
        .range([height, 0])
        .domain([
    d3.min(sc_data, function(d) {return d.y; }),
    d3.max(sc_data, function(d) {return d.y; })
  ]);
  
    
    var line = d3.svg.line()
                .interpolate("basis")
                .x(function(d) {return x(d.x)})
                .y(function(d) {return y(d.y)});
  
    d3.select(this).append('svg')
            .attr('width', width)
            .attr('height', height)
         .append('path')
            .attr('class','line')
            .datum(sc_data)
            .attr('d', line);

}
  

// render the table




    



      function updateData(year,other_year) {
        
        d3.csv("budget_revision.csv", function(error, data) {
                      if (error) throw error;
                      var parseDate = d3.time.format("%Y").parse;
                       data.forEach(function(d) {
                        d.date = parseDate(d.date);
                        
                      }); 
                      updated_data=data;
                      

        var nested = d3.nest()
    .key(function(d) { return d.Type; })
    .map(updated_data)
  
  
    // get value from menu selection
    // the option values are set in HTML and correspond
    //to the [type] value we used to nest the data  
    var series = menu.property("value");
    
    // only retrieve data from the selected series, using the nest we just created
  
   var data_up=nested[series];

        d3.selectAll(".scheme").remove();
   



dataset=[];
    for(var i = 0; i < data_up.length; i++) {
    var obj = data_up[i];
    if(obj.date.getFullYear()==year){
      obj.ide=parseInt("0");

      dataset.push(obj);
    }
      
}
  for(var j = 0 ; j<data_up.length;j++){
    var obj1=data_up[j];
    if( obj1.date.getFullYear()==other_year){

      obj1.ide=parseInt("1");
      dataset.push(obj1);
    }
  }

if(dataset[0].date==dataset[1].date){
var temp = jQuery.extend(true, {}, dataset[0]);
temp.ide=0;
dataset[0]=temp;
}
  
color.domain(d3.keys(dataset[0]).filter(function(key) { return key !== "date" && key!== "Type"; }));



  var schemes = color.domain().map(function(name) {
    
    return {
      name: name,
      values: dataset.map(function(d) { 
        return { budget: +d[name],ide:d.ide};
     
      })
    };
  });


schemes.pop();
x.domain(d3.extent(dataset, function(d) { return d.ide; }));

  y.domain([
    d3.min(schemes, function(c) { return d3.min(c.values, function(v) { return v.budget; }); }),
    d3.max(schemes, function(c) { return d3.max(c.values, function(v) { return v.budget; }); })
  ]);
y1.domain([
    d3.min(schemes, function(c) { return d3.min(c.values, function(v) { return v.budget; }); }),
    d3.max(schemes, function(c) { return d3.max(c.values, function(v) { return v.budget; }); })
  ]);
    


    // Select the section we want to apply our changes to
    
    d3.select("body").transition();
      var scheme = svg.selectAll(".scheme")
      .data(schemes)
    .enter().append("g")
      .attr("class", "scheme");

  scheme.append("path")
      .attr("class", "line")
      .attr("id",function(d,i){ return "id" + i; })
      .attr("d", function(d) { return line(d.values); })
      .style("stroke", function(d) { return color(d.name); });

 scheme
  .append("text")
    .datum(function(d) { return {name: d.name, value: d.values[d.values.length - 1]}; })    
      .attr("transform", function(d) { return "translate(" + (x(d.value.ide) +10)+ "," + y(d.value.budget) + ")"; })
      .attr("id",function(d,i){ return "text_id" + i; })
      .attr("x", 3)
      .attr("dy", ".35em")
      
      .text(function(d) { return d.name; })
      .on("click", function(d) { var url="trend_analysis.html?scheme="+d.name;
        window.open(url); })
      .on("mouseover",function(d,i) { 
        var scheme_name=d3.select("#text_id"+i).html();
        var year1_val, year2_val,year1_num,year2_num; 
        for (var k=0;k<schemes.length;k++){

          if(schemes[k].name==scheme_name){
            year1_val=schemes[k].values[0].budget;
            year2_val=schemes[k].values[1].budget;
            //year1_num=schemes[i].values[0].date.getFullYear();
            //year2_num=schemes[i].values[1].date.getFullYear();
          }
        }
  
        d3.select("#figure-heading").html(scheme_name).on("click", function(d) { var url="trend_analysis.html?scheme="+scheme_name;
        window.open(url); });
        d3.select("#figure-year1").html(year1 + " : " +year1_val+" (Cr)");
        d3.select("#figure-year2").html(year2 + " : " +year2_val+" (Cr)");
          for (j=0; j < 6; j++) {
            if (i !== j) {
              d3.select("#id"+j).style("opacity",0.1);
              d3.select("#text_id"+j).style("opacity",0.2);
              d3.select("#text_id"+i).style("font-size","13px");
              d3.select("#row_id"+j).style("opacity",0.2);
              d3.select("#row_id"+i).style("background-color","#FFF056").style("font-weight","bold");
            }
          };
        })
        .on("mouseout", function(d,i) {
          for (j=0; j < 6; j++) {
            d3.select("#id"+j).style("opacity",1);
            d3.select("#text_id"+j).style("opacity",1);
            d3.select("#text_id"+i).style("font-size","10px");
            d3.select("#row_id"+j).style("opacity",1).style("background-color","white").style("font-weight","normal");
          };
        });
 
});
   
}

 




 
}
  
 

</script>
</script>



</body>

</html>
